<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VT.ai</title>
    <!-- Tailwind CSS CDN for rapid prototyping -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font for modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Motion and Motion-Primitives CDN -->
    <script src="https://unpkg.com/@motion.dev/dom@latest/dist/motion.min.js"></script>
    <script src="https://unpkg.com/motion-primitives@latest/dist/motion-primitives.umd.js"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { inter: ['Inter', 'sans-serif'] },
          },
        },
      }
    </script>
</head>

<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col font-inter dark:bg-gray-900 dark:text-gray-100">
    <header class="bg-indigo-700 text-white px-8 py-4 flex justify-between items-center shadow-lg dark:bg-indigo-900">
        <div class="app-title text-2xl font-bold">
          <motion-text-effect effect="shimmer" per="char" class="inline-block">VT.ai</motion-text-effect>
        </div>
    </header>
    <div class="app-container flex flex-1 h-[calc(100vh-64px)]">
        <!-- Collapsible sidebar -->
        <aside id="sidebar" class="sidebar w-16 sm:w-64 bg-gray-800 p-2 sm:p-6 shadow-md flex flex-col rounded-r-2xl transition-all duration-300 dark:bg-gray-900">
            <button id="sidebar-toggle" class="mb-4 flex items-center justify-center w-10 h-10 rounded-full bg-gray-900 text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <svg id="sidebar-toggle-icon" class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <div id="sidebar-content" class="flex-1 flex flex-col gap-2 overflow-hidden" style="display: none;">
                <motion-accordion class="w-full" variants='{"expanded":{"scale":1.02},"collapsed":{"scale":1}}'>
                    <motion-accordion-item value="settings">
                        <motion-accordion-trigger class="text-base font-semibold mb-2">Settings</motion-accordion-trigger>
                        <motion-accordion-content>
                            <div class="mb-2">
                                <label class="block mb-1 font-medium text-xs" for="model-select">Model</label>
                                <select id="model-select" class="w-full border rounded px-2 py-1 dark:bg-gray-900 dark:border-gray-700 text-xs">
                                    <!-- Model options will be populated dynamically -->
                                </select>
                            </div>
                            <div class="mb-2">
                                <label class="block mb-1 font-medium text-xs" for="temperature">Temp <span id="temperature-value">0.7</span></label>
                                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" class="w-full accent-indigo-700">
                            </div>
                            <div class="mb-2">
                                <label class="block mb-1 font-medium text-xs" for="top-p">Top P <span id="top-p-value">0.9</span></label>
                                <input type="range" id="top-p" min="0" max="1" step="0.1" value="0.9" class="w-full accent-indigo-700">
                            </div>
                        </motion-accordion-content>
                    </motion-accordion-item>
                </motion-accordion>
                <div class="connection-status mt-8 text-center py-2 rounded bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" id="connection-status">
                    Connecting...
                </div>
            </div>
        </aside>
        <main class="chat-container flex-1 flex flex-col p-2 sm:p-6">
            <div class="chat-messages flex-1 overflow-y-auto flex flex-col gap-4 p-4 bg-white rounded-xl shadow-inner dark:bg-gray-900" id="chat-messages">
                <!-- Example assistant message with animated text -->
                <div class="flex items-start gap-2.5">
                  <div class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-700 text-white font-bold dark:bg-indigo-400 dark:text-indigo-900">V</div>
                  <div class="flex flex-col w-full max-w-[320px] leading-1.5">
                    <div class="flex items-center space-x-2 rtl:space-x-reverse">
                      <span class="text-sm font-semibold text-indigo-700 dark:text-indigo-300">VT.ai</span>
                      <span class="text-sm font-normal text-gray-500 dark:text-gray-400">11:47</span>
                    </div>
                    <motion-text-effect effect="scramble" per="word" class="text-sm font-normal py-2.5 text-gray-900 dark:text-white">
                      Hello! I'm VT.ai. How can I help you today?
                    </motion-text-effect>
                    <span class="text-sm font-normal text-gray-500 dark:text-gray-400">Delivered</span>
                  </div>
                </div>
            </div>
            <div class="mt-4 flex gap-2 items-center">
                <input type="text" id="message-input" placeholder="Type your message here..." class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:bg-gray-800 dark:border-gray-700">
                <!-- Glow effect send button -->
                <motion-glow-effect mode="pulse" colors='["#6366f1","#818cf8"]' blur="soft" class="rounded-lg">
                  <motion-button class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg shadow transition font-semibold dark:bg-indigo-800 dark:hover:bg-indigo-900" effect="glow" id="send-button">Send</motion-button>
                </motion-glow-effect>
            </div>
        </main>
    </div>

    <script>
        // Set dark mode by default
        document.documentElement.classList.add('dark');

        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const connectionStatus = document.getElementById('connection-status');
        const modelSelect = document.getElementById('model-select');
        const temperatureSlider = document.getElementById('temperature');
        const temperatureValue = document.getElementById('temperature-value');
        const topPSlider = document.getElementById('top-p');
        const topPValue = document.getElementById('top-p-value');

        // WebSocket connection
        let socket = null;

        // Connect to WebSocket
        function connectWebSocket() {
            // Close existing connection if any
            if (socket) {
                socket.close();
            }

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/chat`;

            connectionStatus.textContent = 'Connecting...';
            connectionStatus.classList.add('disconnected');

            socket = new WebSocket(wsUrl);

            socket.onopen = function () {
                connectionStatus.textContent = 'Connected';
                connectionStatus.classList.remove('disconnected');

                // Initialize session with settings
                sendSettings();
            };

            socket.onmessage = function (event) {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            socket.onclose = function () {
                connectionStatus.textContent = 'Disconnected - Reconnecting...';
                connectionStatus.classList.add('disconnected');

                // Attempt to reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            socket.onerror = function (error) {
                console.error('WebSocket error:', error);
                connectionStatus.textContent = 'Connection Error';
                connectionStatus.classList.add('disconnected');
            };
        }

        // Handle incoming messages
        function handleMessage(data) {
            switch (data.type) {
                case 'AssistantResponse':
                    addMessage(data.data, 'assistant');
                    break;
                case 'Error':
                    addMessage(`Error: ${data.data}`, 'assistant');
                    break;
                case 'Thinking':
                    // Handle thinking state
                    if (data.data) {
                        // Add or update thinking indicator
                    } else {
                        // Remove thinking indicator
                    }
                    break;
                default:
                    console.log('Unhandled message type:', data.type);
            }
        }

        // Add a message to the chat
        function addMessage(content, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('flex', 'items-start', 'gap-2.5');

            // Initial avatar
            const initial = document.createElement('div');
            initial.classList.add('flex', 'items-center', 'justify-center', 'w-8', 'h-8', 'rounded-full', 'font-bold');
            if (sender === 'assistant') {
                initial.classList.add('bg-indigo-700', 'text-white', 'dark:bg-indigo-400', 'dark:text-indigo-900');
                initial.textContent = 'V';
            } else {
                initial.classList.add('bg-indigo-100', 'text-indigo-700', 'dark:bg-indigo-900', 'dark:text-indigo-200');
                initial.textContent = 'Y';
            }
            messageElement.appendChild(initial);

            const messageContent = document.createElement('div');
            messageContent.classList.add('flex', 'flex-col', 'w-full', 'max-w-[320px]', 'leading-1.5');
            messageElement.appendChild(messageContent);

            const messageHeader = document.createElement('div');
            messageHeader.classList.add('flex', 'items-center', 'space-x-2', 'rtl:space-x-reverse');
            messageContent.appendChild(messageHeader);

            const senderName = document.createElement('span');
            senderName.classList.add('text-sm', 'font-semibold');
            if (sender === 'assistant') {
                senderName.classList.add('text-indigo-700', 'dark:text-indigo-300');
                senderName.textContent = 'VT.ai';
            } else {
                senderName.classList.add('text-gray-900', 'dark:text-white');
                senderName.textContent = 'You';
            }
            messageHeader.appendChild(senderName);

            const timestamp = document.createElement('span');
            timestamp.classList.add('text-sm', 'font-normal', 'text-gray-500', 'dark:text-gray-400');
            timestamp.textContent = '11:47';
            messageHeader.appendChild(timestamp);

            const messageText = document.createElement('p');
            messageText.classList.add('text-sm', 'font-normal', 'py-2.5');
            if (sender === 'assistant') {
                messageText.classList.add('text-gray-900', 'dark:text-white');
                messageText.innerHTML = `<motion-text-effect effect="scramble" per="word">${content}</motion-text-effect>`;
            } else {
                messageText.classList.add('text-gray-900', 'dark:text-white');
                messageText.textContent = content;
            }
            messageContent.appendChild(messageText);

            const status = document.createElement('span');
            status.classList.add('text-sm', 'font-normal', 'text-gray-500', 'dark:text-gray-400');
            status.textContent = 'Delivered';
            messageContent.appendChild(status);

            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send a message to the server
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            if (socket && socket.readyState === WebSocket.OPEN) {
                addMessage(message, 'user');

                const data = {
                    type: 'UserMessage',
                    data: message
                };

                socket.send(JSON.stringify(data));
                messageInput.value = '';
            } else {
                alert('Not connected to server. Please wait while we reconnect...');
            }
        }

        // Send settings to the server
        function sendSettings() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                const settings = {
                    chat_model: modelSelect.value,
                    temperature: parseFloat(temperatureSlider.value),
                    top_p: parseFloat(topPSlider.value),
                    image_gen: false,
                    tts: false
                };

                const data = {
                    type: 'SettingsUpdate',
                    data: settings
                };

                socket.send(JSON.stringify(data));
            }
        }

        // Fetch available models from backend and populate dropdown
        async function fetchModels() {
            modelSelect.innerHTML = '<option disabled selected>Loading...</option>';
            try {
                const response = await fetch('/api/models');
                if (!response.ok) throw new Error('Failed to fetch models');
                const models = await response.json();
                modelSelect.innerHTML = '';
                // Sort models alphabetically by label for better UX
                models.sort((a, b) => a.label.localeCompare(b.label));
                models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.label;
                    modelSelect.appendChild(option);
                });
                // Optionally trigger settings update after loading
                sendSettings();
            } catch (err) {
                modelSelect.innerHTML = `<option value="gpt-4.1-mini">GPT-4.1 Mini</option>`;
            }
        }

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);

        messageInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        modelSelect.addEventListener('change', sendSettings);

        temperatureSlider.addEventListener('input', function () {
            temperatureValue.textContent = this.value;
        });

        temperatureSlider.addEventListener('change', sendSettings);

        topPSlider.addEventListener('input', function () {
            topPValue.textContent = this.value;
        });

        topPSlider.addEventListener('change', sendSettings);

        // Collapsible sidebar logic
        const sidebar = document.getElementById('sidebar');
        const sidebarContent = document.getElementById('sidebar-content');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        let sidebarOpen = false;
        function setSidebar(open) {
            sidebarOpen = open;
            if (sidebarOpen) {
                sidebar.classList.remove('w-16');
                sidebar.classList.add('sm:w-64');
                sidebarContent.style.display = 'block';
                sidebarToggle.querySelector('svg').style.transform = 'rotate(0deg)';
            } else {
                sidebar.classList.add('w-16');
                sidebar.classList.remove('sm:w-64');
                sidebarContent.style.display = 'none';
                sidebarToggle.querySelector('svg').style.transform = 'rotate(-90deg)';
            }
        }
        sidebarToggle.addEventListener('click', () => setSidebar(!sidebarOpen));
        setSidebar(false); // Start collapsed

        // Initialize connection when page loads
        window.addEventListener('load', () => {
            fetchModels();
            connectWebSocket();
        });
    </script>
</body>

</html>